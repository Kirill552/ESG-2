/**
 * Foundation Models API –∫–ª–∏–µ–Ω—Ç —á–µ—Ä–µ–∑ OpenAI SDK
 * –°–æ–≤–º–µ—Å—Ç–∏–º—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∏ OCR –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
 */

import 'dotenv/config';
import OpenAI from 'openai';

export interface FoundationModelsConfig {
  apiKey?: string;
  baseUrl?: string;
  defaultModel?: string;
}

export interface ExtractionResult {
  extractedData: any;
  confidence: number;
}

export interface ClassificationResult {
  documentType: string;
  confidence: number;
}

export class FoundationModelsClient {
  private client: OpenAI;
  private defaultModel: string;

  constructor(config?: Partial<FoundationModelsConfig>) {
    // –ß–∏—Ç–∞–µ–º –∏–∑ ENV —Å fallback –Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    const apiKey = config?.apiKey || process.env.FOUNDATION_MODELS_API_KEY;
    const baseUrl = config?.baseUrl || process.env.FOUNDATION_MODELS_BASE_URL || 'https://foundation-models.api.cloud.ru/v1';
    const defaultModel = config?.defaultModel || process.env.FOUNDATION_MODELS_DEFAULT_MODEL || 'GigaChat/GigaChat-2-Max';

    if (!apiKey) {
      throw new Error('FOUNDATION_MODELS_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    this.client = new OpenAI({
      apiKey,
      baseURL: baseUrl
    });
    this.defaultModel = defaultModel;
  }

  /**
   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö
   * –ù–∞–ø—Ä–∏–º–µ—Ä: "zai-org/GLM-4.6" ‚Üí "GLM-4.6"
   */
  private getModelName(): string {
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª—ç—à, –±–µ—Ä–µ–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ —Å–ª—ç—à–∞
    const parts = this.defaultModel.split('/');
    return parts[parts.length - 1] || this.defaultModel;
  }

  /**
   * –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏ OCR –≤ —Ç–µ–∫—Å—Ç–µ
   */
  async fixOcrErrors(ocrText: string): Promise<string> {
    const modelName = this.getModelName();
    console.log(`üîß ${modelName}: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ OCR...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—à–∏–±–æ–∫ OCR –≤ —Ä—É—Å—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö. –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—è —á–∏—Å–ª–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ç–æ—á–Ω–æ.'
          },
          {
            role: 'user',
            content: `–ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ OCR –≤ —ç—Ç–æ–º —Ç–µ–∫—Å—Ç–µ, —Å–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —á–∏—Å–ª–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è (–∫–í—Ç¬∑—á, –ì–∫–∞–ª, –º¬≥, –ª, –∫–º, —Ç):\n\n${ocrText}`
          }
        ],
        max_tokens: Math.min(ocrText.length * 2, 2000),
        temperature: 0.1 // –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
      });

      const fixedText = response.choices[0]?.message?.content || ocrText;
      console.log(`‚úÖ ${modelName}: OCR –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã`);
      return fixedText;
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è OCR:`, error);
      return ocrText;
    }
  }

  /**
   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –ü—Ä–∏–∫–∞–∑—É 371
   */
  async extractEnergyData(text: string): Promise<ExtractionResult> {
    const modelName = this.getModelName();
    console.log(`üìä ${modelName}: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ü—Ä–∏–∫–∞–∑—É –ú–∏–Ω–ø—Ä–∏—Ä–æ–¥—ã 371...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤—ã–±—Ä–æ—Å–æ–≤ –ø–∞—Ä–Ω–∏–∫–æ–≤—ã—Ö –≥–∞–∑–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –ü—Ä–∏–∫–∞–∑—É –ú–∏–Ω–ø—Ä–∏—Ä–æ–¥—ã –†–§ –æ—Ç 27.05.2022 N 371.

–ò–∑–≤–ª–µ–∫–∞–π –¥–∞–Ω–Ω—ã–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "fuel": [
    {"type": "–±–µ–Ω–∑–∏–Ω"|"–¥–∏–∑–µ–ª—å"|"–ø—Ä–∏—Ä–æ–¥–Ω—ã–π –≥–∞–∑"|"–º–∞–∑—É—Ç"|"—É–≥–æ–ª—å"|"–∫–µ—Ä–æ—Å–∏–Ω"|"–∫–æ–∫—Å", "value": —á–∏—Å–ª–æ, "unit": "–ª"|"—Ç"|"–º¬≥"|"—Ç—ã—Å. –º¬≥"}
  ],
  "electricity": [
    {"value": —á–∏—Å–ª–æ, "unit": "–∫–í—Ç¬∑—á"|"–ú–í—Ç¬∑—á", "period": "–ø–µ—Ä–∏–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å"}
  ],
  "heat": [
    {"value": —á–∏—Å–ª–æ, "unit": "–ì–∫–∞–ª", "period": "–ø–µ—Ä–∏–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å"}
  ]
}

–í–ê–ñ–ù–û:
- –¢–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–π –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è: –ª (–ª–∏—Ç—Ä—ã), —Ç (—Ç–æ–Ω–Ω—ã), –º¬≥ (–∫—É–±–æ–º–µ—Ç—Ä—ã), –∫–í—Ç¬∑—á (–∫–∏–ª–æ–≤–∞—Ç—Ç-—á–∞—Å—ã), –ì–∫–∞–ª (–≥–∏–≥–∞–∫–∞–ª–æ—Ä–∏–∏)
- –†–∞–∑–ª–∏—á–∞–π –≤–∏–¥—ã —Ç–æ–ø–ª–∏–≤–∞: –±–µ–Ω–∑–∏–Ω, –¥–∏–∑–µ–ª—å, –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –≥–∞–∑, —É–≥–æ–ª—å, –º–∞–∑—É—Ç
- –ò–∑–≤–ª–µ–∫–∞–π –¢–û–õ–¨–ö–û —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏`
          },
          {
            role: 'user',
            content: `–ò–∑–≤–ª–µ–∫–∏ –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï –û –†–ê–°–•–û–î–ï –†–ï–°–£–†–°–û–í (–ù–ï –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —ç–º–∏—Å—Å–∏–∏!):

–ò–©–ï–ú:
- –†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü—ã (–ª, —Ç, –º¬≥, —Ç—ã—Å. –º¬≥)
- –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü—ã (–∫–í—Ç¬∑—á, –ú–í—Ç¬∑—á, –ì–∫–∞–ª)
- –ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞ (–≥–æ–¥, –∫–≤–∞—Ä—Ç–∞–ª, –º–µ—Å—è—Ü)
- –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞/—Ñ–∏–ª–∏–∞–ª–∞ (–∫–æ—Ç–µ–ª—å–Ω–∞—è, —Ü–µ—Ö, –∏ —Ç.–¥.)

–ù–ï –∏–∑–≤–ª–µ–∫–∞–π:
- EF, OF, k, NCV - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (–æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ!)
- –í—ã–±—Ä–æ—Å—ã CO‚ÇÇ, CO‚ÇÇ-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–æ–≤
- –ò–ù–ù, –û–ì–†–ù, –ö–ü–ü - —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –î–ê–ù–ù–´–•:
"–†–∞—Å—Ö–æ–¥ –ø—Ä–∏—Ä–æ–¥–Ω–æ–≥–æ –≥–∞–∑–∞: 27855 —Ç—ã—Å. –º¬≥"
"–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–∏–∑—Ç–æ–ø–ª–∏–≤–∞: 5000 –ª"
"–ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ –º–∞–∑—É—Ç–∞ –ú40: 150 —Ç"
"–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è: 50000 –∫–í—Ç¬∑—á"
"–¢–µ–ø–ª–æ–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è: 1200 –ì–∫–∞–ª"

–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n\n${text}`
          }
        ],
        max_tokens: 1500,
        temperature: 0.2
      });

      const content = response.choices[0]?.message?.content || '{}';

      // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const extractedData = JSON.parse(jsonMatch[0]);

        // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const totalItems = Object.values(extractedData).reduce((sum: number, arr: any) =>
          sum + (Array.isArray(arr) ? arr.length : 0), 0);
        const confidence = Math.min(totalItems * 0.2 + 0.3, 0.9);

        console.log(`‚úÖ ${modelName}: –¥–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø–æ –ü—Ä–∏–∫–∞–∑—É 371`);
        return { extractedData, confidence };
      }

      return { extractedData: {}, confidence: 0.1 };
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:`, error);
      return { extractedData: {}, confidence: 0 };
    }
  }

  /**
   * –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
   */
  async classifyDocument(text: string): Promise<ClassificationResult> {
    const modelName = this.getModelName();
    console.log(`üè∑Ô∏è ${modelName}: –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: '–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞. –û—Ç–≤–µ—á–∞–π –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: —Å—á–µ—Ç, –Ω–∞–∫–ª–∞–¥–Ω–∞—è, –∞–∫—Ç, —Å–ø—Ä–∞–≤–∫–∞, –¥–æ–≥–æ–≤–æ—Ä, –æ—Ç—á–µ—Ç, –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ.'
          },
          {
            role: 'user',
            content: `–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:\n\n${text.substring(0, 500)}...`
          }
        ],
        max_tokens: 50,
        temperature: 0.1
      });

      const content = response.choices[0]?.message?.content?.toLowerCase().trim() || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –∫–∞–∫ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
      const documentType = content.split(/\s+/)[0];
      
      // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
      const knownTypes = ['—Å—á–µ—Ç', '–Ω–∞–∫–ª–∞–¥–Ω–∞—è', '–∞–∫—Ç', '—Å–ø—Ä–∞–≤–∫–∞', '–¥–æ–≥–æ–≤–æ—Ä', '–æ—Ç—á–µ—Ç'];
      const confidence = knownTypes.includes(documentType) ? 0.8 : 0.3;

      console.log(`‚úÖ ${modelName}: –¥–æ–∫—É–º–µ–Ω—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω`);
      return { documentType, confidence };
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:`, error);
      return { documentType: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', confidence: 0 };
    }
  }

  /**
   * –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è ESG –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏
   */
  async classifyDocumentCategory(text: string): Promise<{
    category: '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ' | '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏' | '–û—Ç—Ö–æ–¥—ã' | '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç' | '–≠–Ω–µ—Ä–≥–∏—è' | '–ü—Ä–æ—á–µ–µ';
    confidence: number;
  }> {
    const modelName = this.getModelName();
    console.log(`üè∑Ô∏è ${modelName}: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ESG –¥–æ–∫—É–º–µ–Ω—Ç–∞...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è ESG –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏.
            –û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:
            - –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: –¥–æ–∫—É–º–µ–Ω—Ç—ã –æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö, –≤—ã–±—Ä–æ—Å–∞—Ö, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
            - –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏: —Å—á–µ—Ç–∞, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –¥–æ–≥–æ–≤–æ—Ä—ã —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏ —Å—ã—Ä—å—è, –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, —Ç–æ–ø–ª–∏–≤–∞
            - –û—Ç—Ö–æ–¥—ã: –¥–æ–∫—É–º–µ–Ω—Ç—ã –æ–± —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏, –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–µ, –≤—ã–≤–æ–∑–µ –æ—Ç—Ö–æ–¥–æ–≤
            - –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: –ø—É—Ç–µ–≤—ã–µ –ª–∏—Å—Ç—ã, –¥–∞–Ω–Ω—ã–µ –æ –ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö, —Ä–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            - –≠–Ω–µ—Ä–≥–∏—è: —Å—á–µ—Ç–∞ –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, –≥–∞–∑, —Ç–µ–ø–ª–æ, –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ —ç–Ω–µ—Ä–≥–æ—Ä–µ—Å—É—Ä—Å–æ–≤
            - –ü—Ä–æ—á–µ–µ: –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

            –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º.`
          },
          {
            role: 'user',
            content: `–û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:\n\n${text.substring(0, 800)}...`
          }
        ],
        max_tokens: 20,
        temperature: 0.1
      });

      const content = response.choices[0]?.message?.content?.trim() || '–ü—Ä–æ—á–µ–µ';

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–≤–µ—Ç –∫ –æ–¥–Ω–æ–π –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      const categoryMap: Record<string, '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ' | '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏' | '–û—Ç—Ö–æ–¥—ã' | '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç' | '–≠–Ω–µ—Ä–≥–∏—è' | '–ü—Ä–æ—á–µ–µ'> = {
        '–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ': '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ',
        '–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏': '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏',
        '–æ—Ç—Ö–æ–¥—ã': '–û—Ç—Ö–æ–¥—ã',
        '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç': '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        '—ç–Ω–µ—Ä–≥–∏—è': '–≠–Ω–µ—Ä–≥–∏—è',
        '–ø—Ä–æ—á–µ–µ': '–ü—Ä–æ—á–µ–µ'
      };

      const normalizedContent = content.toLowerCase();
      const category = categoryMap[normalizedContent] || '–ü—Ä–æ—á–µ–µ';

      // –û—Ü–µ–Ω–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
      const confidence = category !== '–ü—Ä–æ—á–µ–µ' ? 0.85 : 0.4;

      console.log(`‚úÖ ${modelName}: –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ - ${category} (${confidence})`);
      return { category, confidence };
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:`, error);
      return { category: '–ü—Ä–æ—á–µ–µ', confidence: 0 };
    }
  }

  /**
   * –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—è Function Calling –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Tool Calling API –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
   */
  async classifyDocumentCategoryWithTools(text: string, fileName?: string): Promise<{
    category: 'PRODUCTION' | 'SUPPLIERS' | 'WASTE' | 'TRANSPORT' | 'ENERGY' | 'OTHER';
    subcategory?: string;
    confidence: number;
    reasoning: string;
  }> {
    const modelName = this.getModelName();
    console.log(`üéØ ${modelName}: –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å Function Calling...`);

    try {
      const tools: OpenAI.Chat.Completions.ChatCompletionTool[] = [{
        type: "function" as const,
        function: {
          name: "classify_document_category",
          description: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ 296-–§–ó –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞",
          parameters: {
            type: "object",
            properties: {
              category: {
                type: "string",
                enum: ["PRODUCTION", "SUPPLIERS", "WASTE", "TRANSPORT", "ENERGY", "OTHER"],
                description: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–±—Ä–æ—Å–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ 296-–§–ó: PRODUCTION (–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ), SUPPLIERS (–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏), WASTE (–æ—Ç—Ö–æ–¥—ã), TRANSPORT (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç), ENERGY (—ç–Ω–µ—Ä–≥–∏—è), OTHER (–ø—Ä–æ—á–µ–µ)"
              },
              subcategory: {
                type: "string",
                description: "–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –Ω–∞–ø—Ä–∏–º–µ—Ä '–ü—Ä–∏—Ä–æ–¥–Ω—ã–π –≥–∞–∑', '–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è', '–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'"
              },
              confidence: {
                type: "number",
                minimum: 0,
                maximum: 1,
                description: "–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç 0 –¥–æ 1"
              },
              reasoning: {
                type: "string",
                description: "–ö—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"
              }
            },
            required: ["category", "confidence", "reasoning"]
          }
        }
      }];

      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –ø–æ –≤—ã–±—Ä–æ—Å–∞–º –ø–∞—Ä–Ω–∏–∫–æ–≤—ã—Ö –≥–∞–∑–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ 296-–§–ó.

–í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –¥–æ—Å—Ç—É–ø–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é classify_document_category –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞!

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:

1. PRODUCTION (–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ):
   * –ü—Ä–∏–∑–Ω–∞–∫–∏: –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –∑–∞–≤–æ–¥, —Ñ–∞–±—Ä–∏–∫–∞, —Ü–µ—Ö, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
   * –°–æ–¥–µ—Ä–∂–∏—Ç: –≤—ã–ø—É—Å–∫ –ø—Ä–æ–¥—É–∫—Ü–∏–∏, –æ–±—ä–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–æ—â–Ω–æ—Å—Ç–∏
   * –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ, –≤—ã–ø–ª–∞–≤–∫–∞, –≤—ã–ø—É—Å–∫, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ª–∏–Ω–∏—è
   * –ü—Ä–∏–º–µ—Ä—ã: –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ, –∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ, –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã—Ö –≤—ã–±—Ä–æ—Å–∞—Ö
   * –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ 3+ –ø—Ä–∏–∑–Ω–∞–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí PRODUCTION

2. SUPPLIERS (–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏):
   * –ü—Ä–∏–∑–Ω–∞–∫–∏: –∑–∞–∫—É–ø–∫–∞, –ø–æ—Å—Ç–∞–≤–∫–∞, —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É, –Ω–∞–∫–ª–∞–¥–Ω–∞—è –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞, –¥–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏
   * –°–æ–¥–µ—Ä–∂–∏—Ç: –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ü–µ–Ω–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫, –ø–æ–∫—É–ø–∞—Ç–µ–ª—å, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Å—Ç–æ—Ä–æ–Ω
   * –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —Å—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞, —Ç–æ–≤–∞—Ä–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è (–ù–ï —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è!), –¢–û–†–ì-12, –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–æ, –∑–∞–∫—É–ø–∫–∞ —Ç–æ–ø–ª–∏–≤–∞, –∑–∞–∫—É–ø–∫–∞ —Å—ã—Ä—å—è, –∑–∞–∫—É–ø–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
   * –ü—Ä–∏–º–µ—Ä—ã: —Å—á–µ—Ç –∑–∞ —Ç–æ–ø–ª–∏–≤–æ –æ—Ç –ê–ó–°, –Ω–∞–∫–ª–∞–¥–Ω–∞—è –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É —É–≥–ª—è, –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –∑–∞–∫—É–ø–∫—É –≥–∞–∑–∞
   * –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ 3+ –ø—Ä–∏–∑–Ω–∞–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Üí SUPPLIERS

3. WASTE (–û—Ç—Ö–æ–¥—ã):
   * –ü—Ä–∏–∑–Ω–∞–∫–∏: —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è, –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞, –≤—ã–≤–æ–∑ –æ—Ç—Ö–æ–¥–æ–≤, –ø–æ–ª–∏–≥–æ–Ω, –º—É—Å–æ—Ä, –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
   * –°–æ–¥–µ—Ä–∂–∏—Ç: –≤–∏–¥ –æ—Ç—Ö–æ–¥–æ–≤, –∫–ª–∞—Å—Å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –º–∞—Å—Å–∞/–æ–±—ä–µ–º –æ—Ç—Ö–æ–¥–æ–≤, —Å–ø–æ—Å–æ–± —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è-–ø–µ—Ä–µ—Ä–∞–±–æ—Ç—á–∏–∫
   * –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –¢–ë–û (—Ç–≤–µ—Ä–¥—ã–µ –±—ã—Ç–æ–≤—ã–µ –æ—Ç—Ö–æ–¥—ã), –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç—Ö–æ–¥—ã, –ª–æ–º, –º–µ—Ç–∞–ª–ª–æ–ª–æ–º, –º–∞–∫—É–ª–∞—Ç—É—Ä–∞, —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è, –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞, –∑–∞—Ö–æ—Ä–æ–Ω–µ–Ω–∏–µ, –º—É—Å–æ—Ä–æ–≤—ã–≤–æ–∑
   * –ü—Ä–∏–º–µ—Ä—ã: –∞–∫—Ç –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏ –æ—Ç—Ö–æ–¥–æ–≤, –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞, —Å–ø—Ä–∞–≤–∫–∞ –æ–± —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
   * –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ 3+ –ø—Ä–∏–∑–Ω–∞–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–± –æ—Ç—Ö–æ–¥–∞—Ö ‚Üí WASTE

4. TRANSPORT (–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç):
   * –ü—Ä–∏–∑–Ω–∞–∫–∏: —Ç–æ–≤–∞—Ä–Ω–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –Ω–∞–∫–ª–∞–¥–Ω–∞—è, –¢–¢–ù, –ø—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç, –∞–∫—Ç –æ–∫–∞–∑–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —É—Å–ª—É–≥, –ø–µ—Ä–µ–≤–æ–∑–∫–∞ –≥—Ä—É–∑–∞
   * –°–æ–¥–µ—Ä–∂–∏—Ç: –º–∞—Ä—à—Ä—É—Ç (–æ—Ç–∫—É–¥–∞-–∫—É–¥–∞), –∞–≤—Ç–æ–º–æ–±–∏–ª—å (–º–∞—Ä–∫–∞/–º–æ–¥–µ–ª—å), –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä, –≤–æ–¥–∏—Ç–µ–ª—å (–§–ò–û), –≥—Ä—É–∑, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –¥–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–∑–∫–∏
   * –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ø–µ—Ä–µ–≤–æ–∑–∫–∞, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –¥–æ—Å—Ç–∞–≤–∫–∞ –≥—Ä—É–∑–æ–≤, –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–≤–æ–∑–∫–∞, –≤–æ–¥–∏—Ç–µ–ª—å, –≥–æ—Å–Ω–æ–º–µ—Ä, –º–∞—Ä—à—Ä—É—Ç —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø—É–Ω–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
   * –ü—Ä–∏–º–µ—Ä—ã: –¢–¢–ù ‚Ññ123, –ø—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç –≤–æ–¥–∏—Ç–µ–ª—è, –∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑–æ–∫
   * –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ 3+ –ø—Ä–∏–∑–Ω–∞–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí TRANSPORT

5. ENERGY (–≠–Ω–µ—Ä–≥–∏—è):
   * –ü—Ä–∏–∑–Ω–∞–∫–∏: –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–æ—Ä–µ—Å—É—Ä—Å–æ–≤, —Å—á–µ—Ç –∑–∞ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, —ç–ª–µ–∫—Ç—Ä–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ, —Ç–µ–ø–ª–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ, –≥–∞–∑–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ
   * –°–æ–¥–µ—Ä–∂–∏—Ç: –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤, —Ä–∞—Å—Ö–æ–¥ —ç–Ω–µ—Ä–≥–∏–∏, —Ç–∞—Ä–∏—Ñ, –Ω–∞—á–∏—Å–ª–µ–Ω–æ, –æ–±—ä–µ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è, –ø–µ—Ä–∏–æ–¥ —Ä–∞—Å—á–µ—Ç–∞
   * –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è, –∫–í—Ç¬∑—á, —Ç–µ–ø–ª–æ–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è, –ì–∫–∞–ª, –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –≥–∞–∑, –º¬≥, –≥–∞–∑–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ, —ç–Ω–µ—Ä–≥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ, —Ä–µ—Å—É—Ä—Å–æ—Å–Ω–∞–±–∂–∞—é—â–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
   * –ü—Ä–∏–º–µ—Ä—ã: —Å—á–µ—Ç –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, –∞–∫—Ç –æ–± –æ—Ç–ø—É—Å–∫–µ —Ç–µ–ø–ª–∞, –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∞ –≥–∞–∑–∞
   * –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ 3+ –ø—Ä–∏–∑–Ω–∞–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–± —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ ‚Üí ENERGY

6. OTHER (–ü—Ä–æ—á–µ–µ):
   * –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ù–ï –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –ø–æ–¥ –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤—ã—à–µ
   * –ü—Ä–∏–º–µ—Ä—ã: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –¥–æ–≥–æ–≤–æ—Ä—ã –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ä–µ—Å—É—Ä—Å–∞–º, –æ–±—â–∞—è –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü–∏—è

–ü–†–ê–í–ò–õ–û –ü–†–ò–û–†–ò–¢–ï–¢–ê:
- –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Ö–æ–∂ –Ω–∞ SUPPLIERS –∏ TRANSPORT ‚Üí –≤—ã–±–∏—Ä–∞–π –ø–æ –Ω–∞–ª–∏—á–∏—é –ú–ê–†–®–†–£–¢–ê –∏ –ê–í–¢–û–ú–û–ë–ò–õ–Ø (–µ—Å–ª–∏ –µ—Å—Ç—å ‚Üí TRANSPORT)
- –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–∫—É–ø–∫—É —Ç–æ–ø–ª–∏–≤–∞ –ë–ï–ó –ø–µ—Ä–µ–≤–æ–∑–∫–∏ ‚Üí SUPPLIERS
- –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–≤–æ–∑–∫—É –° —É–∫–∞–∑–∞–Ω–∏–µ–º –º–∞—Ä—à—Ä—É—Ç–∞ ‚Üí TRANSPORT

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –µ–≥–æ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.`
          },
          {
            role: 'user',
            content: `–û–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞:

–ò–º—è —Ñ–∞–π–ª–∞: ${fileName || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ (–ø–µ—Ä–≤—ã–µ 1500 —Å–∏–º–≤–æ–ª–æ–≤):
${text.substring(0, 1500)}...`
          }
        ],
        tools,
        max_tokens: 500,
        temperature: 0.2
      });

      const message = response.choices[0]?.message;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ tool
      if (message?.tool_calls && message.tool_calls.length > 0) {
        const toolCall = message.tool_calls[0];
        const args = JSON.parse(toolCall.function.arguments);

        console.log(`‚úÖ ${modelName} Function Calling —Ä–µ–∑—É–ª—å—Ç–∞—Ç:`, {
          category: args.category,
          confidence: args.confidence,
          reasoning: args.reasoning?.substring(0, 100)
        });

        return {
          category: args.category,
          subcategory: args.subcategory,
          confidence: args.confidence || 0.7,
          reasoning: args.reasoning || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
        };
      }

      // Fallback: –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ tool
      console.warn(`‚ö†Ô∏è ${modelName} –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ Function Calling, fallback –Ω–∞ –æ–±—ã—á–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—é`);
      const fallback = await this.classifyDocumentCategory(text);

      const categoryMapping: Record<string, 'PRODUCTION' | 'SUPPLIERS' | 'WASTE' | 'TRANSPORT' | 'ENERGY' | 'OTHER'> = {
        '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ': 'PRODUCTION',
        '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏': 'SUPPLIERS',
        '–û—Ç—Ö–æ–¥—ã': 'WASTE',
        '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': 'TRANSPORT',
        '–≠–Ω–µ—Ä–≥–∏—è': 'ENERGY',
        '–ü—Ä–æ—á–µ–µ': 'OTHER'
      };

      return {
        category: categoryMapping[fallback.category],
        confidence: fallback.confidence,
        reasoning: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Function Calling'
      };

    } catch (error) {
      console.error(`‚ùå ${modelName} Function Calling –æ—à–∏–±–∫–∞:`, error);

      // –ü–æ–ª–Ω—ã–π fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
      try {
        const fallback = await this.classifyDocumentCategory(text);
        const categoryMapping: Record<string, 'PRODUCTION' | 'SUPPLIERS' | 'WASTE' | 'TRANSPORT' | 'ENERGY' | 'OTHER'> = {
          '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ': 'PRODUCTION',
          '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏': 'SUPPLIERS',
          '–û—Ç—Ö–æ–¥—ã': 'WASTE',
          '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': 'TRANSPORT',
          '–≠–Ω–µ—Ä–≥–∏—è': 'ENERGY',
          '–ü—Ä–æ—á–µ–µ': 'OTHER'
        };

        return {
          category: categoryMapping[fallback.category],
          confidence: fallback.confidence * 0.8, // –°–Ω–∏–∂–∞–µ–º confidence –∏–∑-–∑–∞ fallback
          reasoning: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ Function Calling'
        };
      } catch {
        return {
          category: 'OTHER',
          confidence: 0,
          reasoning: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é'
        };
      }
    }
  }

  /**
   * –°–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
   */
  async complexAnalysis(text: string, task: string): Promise<string> {
    const modelName = this.getModelName();
    console.log(`üß† ${modelName}: —Å–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∏ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ü—Ä–æ–≤–æ–¥–∏ –≥–ª—É–±–æ–∫–∏–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑.'
          },
          {
            role: 'user',
            content: `${task}\n\n–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:\n${text}`
          }
        ],
        max_tokens: 2000,
        temperature: 0.3
      });

      const result = response.choices[0]?.message?.content || '';
      console.log(`‚úÖ ${modelName}: —Å–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω`);
      return result;
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ —Å–ª–æ–∂–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:`, error);
      return '';
    }
  }

  /**
   * –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ chat completion
   */
  async chatCompletion(messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[], options?: {
    model?: string;
    max_tokens?: number;
    temperature?: number;
  }): Promise<OpenAI.Chat.Completions.ChatCompletion> {
    return await this.client.chat.completions.create({
      model: options?.model || this.defaultModel,
      messages,
      max_tokens: options?.max_tokens || 1000,
      temperature: options?.temperature || 0.7
    });
  }

  /**
   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¢–¢–ù, –∞–∫—Ç –ø–µ—Ä–µ–≤–æ–∑–∫–∏, –ø—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç)
   * –ó–∞–¥–∞—á–∞ 10.2 –∏–∑ OCR-REPORTS.md
   */
  async extractTransportDocumentData(text: string): Promise<{
    vehicle: {
      model: string;
      licensePlate: string;
      modelConfidence: number;
    };
    route: {
      from: string;
      to: string;
      fromCity: string;
      toCity: string;
    };
    cargo?: {
      weight: number;
      unit: string;
    };
    confidence: number;
  }> {
    const modelName = this.getModelName();
    console.log(`üöó ${modelName}: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–¢–¢–ù, –∞–∫—Ç—ã –ø–µ—Ä–µ–≤–æ–∑–∫–∏, –ø—É—Ç–µ–≤—ã–µ –ª–∏—Å—Ç—ã).

–í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON! –ù–∏–∫–∞–∫–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!

–ü–†–ò–ú–ï–†–´ –£–°–ü–ï–®–ù–û–ì–û –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø:

–ü–†–ò–ú–ï–† 1 - –ê–ö–¢ –ü–ï–†–ï–í–û–ó–ö–ò:
–¢–µ–∫—Å—Ç: "–¢—è–≥–∞—á –ì–∞–∑–µ–ª—å –¢ 223 –ù–ú 196 RUS, –º–∞—Ä—à—Ä—É—Ç –≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ ‚Üí –≥. –ú–æ—Å–∫–≤–∞, –•–æ—Ä–æ—à–µ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, 27"
–û—Ç–≤–µ—Ç:
{
  "vehicle": {
    "model": "–ì–∞–∑–µ–ª—å",
    "licensePlate": "–¢ 223 –ù–ú 196 RUS",
    "modelConfidence": 0.9
  },
  "route": {
    "from": "–≥. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
    "to": "–≥. –ú–æ—Å–∫–≤–∞, –•–æ—Ä–æ—à–µ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ, 27",
    "fromCity": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
    "toCity": "–ú–æ—Å–∫–≤–∞"
  },
  "cargo": null
}

–ü–†–ò–ú–ï–† 2 - –¢–¢–ù –° –ü–û–õ–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò:
–¢–µ–∫—Å—Ç: "–ê–≤—Ç–æ–º–æ–±–∏–ª—å –ú–µ—Ä—Å–µ–¥–µ—Å –†395–ê–£40, –º–∞—Ä—à—Ä—É—Ç: 391523 –†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª., —Å–µ–ª–æ –ú–æ—Å–æ–ª–æ–≤–æ ‚Üí 140100 –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª., –≥–æ—Ä–æ–¥ –†–∞–º–µ–Ω—Å–∫–æ–µ. –ú–∞—Å—Å–∞ –±—Ä—É—Ç—Ç–æ: 5 —Ç."
–û—Ç–≤–µ—Ç:
{
  "vehicle": {
    "model": "–ú–µ—Ä—Å–µ–¥–µ—Å",
    "licensePlate": "–†395–ê–£40",
    "modelConfidence": 0.95
  },
  "route": {
    "from": "391523 –†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª., —Å–µ–ª–æ –ú–æ—Å–æ–ª–æ–≤–æ",
    "to": "140100 –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª., –≥–æ—Ä–æ–¥ –†–∞–º–µ–Ω—Å–∫–æ–µ",
    "fromCity": "–ú–æ—Å–æ–ª–æ–≤–æ",
    "toCity": "–†–∞–º–µ–Ω—Å–∫–æ–µ"
  },
  "cargo": {
    "weight": 5,
    "unit": "—Ç"
  }
}

–ü–†–ê–í–ò–õ–ê –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø:
1. –ê–≤—Ç–æ–º–æ–±–∏–ª—å: –∏—â–∏ –º–∞—Ä–∫—É (–ì–∞–∑–µ–ª—å, –ö–ê–ú–ê–ó, –ú–µ—Ä—Å–µ–¥–µ—Å, –§—É—Ä–∞, –ú–ê–ó, –ó–ò–õ, –∏ —Ç.–¥.)
2. –ì–æ—Å–Ω–æ–º–µ—Ä: –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Å —Ä–µ–≥–∏–æ–Ω–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä "–¢ 223 –ù–ú 196 RUS" –∏–ª–∏ "–†395–ê–£40")
3. –ú–∞—Ä—à—Ä—É—Ç: –∏—â–∏ —Å–ª–æ–≤–∞ "–º–∞—Ä—à—Ä—É—Ç", "–æ—Ç", "–¥–æ", "–æ—Ç–∫—É–¥–∞", "–∫—É–¥–∞", —Å—Ç—Ä–µ–ª–∫–∏ "‚Üí"
4. –ì–æ—Ä–æ–¥–∞: –∏–∑–≤–ª–µ–∫–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞/–Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ (–±–µ–∑ –æ–±–ª–∞—Å—Ç–∏/–∫—Ä–∞—è)
5. –ì—Ä—É–∑: –∏—â–∏ "–º–∞—Å—Å–∞", "–≤–µ—Å", "—Ç–æ–Ω–Ω", "–∫–≥", "—Ç"

–í–ê–ñ–ù–û - –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
- –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–π JSON –±–µ–∑ markdown, –±–µ–∑ –∫–æ–¥–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π!
- –ï—Å–ª–∏ –ø–æ–ª–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û (vehicle.model, vehicle.licensePlate, route.fromCity, route.toCity), –Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É ""
- –ï—Å–ª–∏ –ø–æ–ª–µ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (cargo) –∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí –≤–µ—Ä–Ω–∏ null
- modelConfidence: 0.9+ –µ—Å–ª–∏ –º–∞—Ä–∫–∞ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–∞, 0.7+ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã/—Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, 0.5+ –µ—Å–ª–∏ —É–≥–∞–¥–∞–ª –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

–ü–†–ò–ú–ï–† –û–¢–í–ï–¢–ê –î–õ–Ø –ù–ï–ü–û–õ–ù–´–• –î–ê–ù–ù–´–•:
{
  "vehicle": {"model": "–ì–∞–∑–µ–ª—å", "licensePlate": "", "modelConfidence": 0.8},
  "route": {"from": "–≥. –ú–æ—Å–∫–≤–∞", "to": "", "fromCity": "–ú–æ—Å–∫–≤–∞", "toCity": ""},
  "cargo": null
}`
          },
          {
            role: 'user',
            content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ –∏–∑–≤–ª–µ–∫–∏:

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã–±—Ä–æ—Å–æ–≤:
- –ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è
- –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
- –ú–∞—Ä—à—Ä—É—Ç: –æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞ (–Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ)

–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û:
- –í–µ—Å –≥—Ä—É–∑–∞ (—á–∏—Å–ª–æ + –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è)

–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n\n${text}`
          }
        ],
        max_tokens: 1000,
        temperature: 0.2
      });

      const content = response.choices[0]?.message?.content || '{}';

      // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const data = JSON.parse(jsonMatch[0]);

        // –û—Ü–µ–Ω–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
        let confidence = 0.5;
        if (data.vehicle?.model && data.vehicle?.licensePlate) confidence += 0.2;
        if (data.route?.fromCity && data.route?.toCity) confidence += 0.2;
        if (data.cargo?.weight) confidence += 0.1;

        console.log(`‚úÖ ${modelName}: –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑–≤–ª–µ—á–µ–Ω—ã`);
        return {
          vehicle: data.vehicle || { model: '', licensePlate: '', modelConfidence: 0 },
          route: data.route || { from: '', to: '', fromCity: '', toCity: '' },
          cargo: data.cargo,
          confidence
        };
      }

      return {
        vehicle: { model: '', licensePlate: '', modelConfidence: 0 },
        route: { from: '', to: '', fromCity: '', toCity: '' },
        confidence: 0.1
      };
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:`, error);
      return {
        vehicle: { model: '', licensePlate: '', modelConfidence: 0 },
        route: { from: '', to: '', fromCity: '', toCity: '' },
        confidence: 0
      };
    }
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ –º–∞—Ä–∫–µ/–º–æ–¥–µ–ª–∏
   * –ó–∞–¥–∞—á–∞ 10.3 –∏–∑ OCR-REPORTS.md
   */
  async determineFuelType(
    vehicleModel: string,
    licensePlate?: string
  ): Promise<{
    fuelType: 'gasoline' | 'diesel' | 'unknown';
    confidence: number;
    reasoning: string;
    year?: number;
    engineType?: string;
  }> {
    const modelName = this.getModelName();
    console.log(`üîç ${modelName}: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ç–æ–ø–ª–∏–≤–∞ –¥–ª—è "${vehicleModel}"...`);

    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–º –∏ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º –∏ –≥—Ä—É–∑–æ–≤–æ–º—É —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É.
–û–ø—Ä–µ–¥–µ–ª—è–π —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ä–∫–∏ –∏ –º–æ–¥–µ–ª–∏.

–í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON! –ù–∏–∫–∞–∫–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!

–ü–†–ê–í–ò–õ–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø:
1. –ì–†–£–ó–û–í–ò–ö–ò –∏ –§–£–†–´ (1.5+ —Ç–æ–Ω–Ω) ‚Üí –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –¥–∏–∑–µ–ª—å (confidence: 0.85+)
2. –õ–ï–ì–ö–ò–ï –ö–û–ú–ú–ï–†–ß–ï–°–ö–ò–ï (<1.5 —Ç–æ–Ω–Ω) ‚Üí —á–∞—â–µ –¥–∏–∑–µ–ª—å, —Ä–µ–∂–µ –±–µ–Ω–∑–∏–Ω (confidence: 0.7+)
3. –õ–ï–ì–ö–û–í–´–ï ‚Üí –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Ä–∫–∏/–º–æ–¥–µ–ª–∏ (confidence: 0.8+)

–ü–†–ò–ú–ï–†–´ –ì–†–£–ó–û–í–´–•:
- –ú–µ—Ä—Å–µ–¥–µ—Å (–±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è) ‚Üí –¥–∏–∑–µ–ª—å 0.9 (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ Mercedes –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤ –Ω–∞ –¥–∏–∑–µ–ª–µ)
- –ú–µ—Ä—Å–µ–¥–µ—Å –°–ø—Ä–∏–Ω—Ç–µ—Ä ‚Üí –¥–∏–∑–µ–ª—å 0.9
- –ú–µ—Ä—Å–µ–¥–µ—Å –ê–∫—Ç—Ä–æ—Å ‚Üí –¥–∏–∑–µ–ª—å 1.0 (—Ç–æ–ª—å–∫–æ –¥–∏–∑–µ–ª—å)
- –ö–ê–ú–ê–ó (–ª—é–±–∞—è –º–æ–¥–µ–ª—å) ‚Üí –¥–∏–∑–µ–ª—å 1.0 (—Ç–æ–ª—å–∫–æ –¥–∏–∑–µ–ª—å)
- –ú–ê–ó ‚Üí –¥–∏–∑–µ–ª—å 1.0
- –ó–ò–õ-130 ‚Üí –±–µ–Ω–∑–∏–Ω 0.9 (—Å—Ç–∞—Ä—ã–µ –≥—Ä—É–∑–æ–≤–∏–∫–∏)
- –§—É—Ä–∞ / –ì—Ä—É–∑–æ–≤–∏–∫ / –¢—è–≥–∞—á ‚Üí –¥–∏–∑–µ–ª—å 0.85 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–ü–†–ò–ú–ï–†–´ –õ–ï–ì–ö–ò–• –ö–û–ú–ú–ï–†–ß–ï–°–ö–ò–•:
- –ì–ê–ó–µ–ª—å 3302 (–¥–æ 2018) ‚Üí –±–µ–Ω–∑–∏–Ω 0.8 (–£–ú–ó-4216)
- –ì–ê–ó–µ–ª—å Next (–ø–æ—Å–ª–µ 2013) ‚Üí –¥–∏–∑–µ–ª—å 0.8 (Cummins ISF 2.8)
- –ì–ê–ó–µ–ª—å (–±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è) ‚Üí –±–µ–Ω–∑–∏–Ω 0.7 (—Å—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ —á–∞—â–µ –±–µ–Ω–∑–∏–Ω)
- Volkswagen Transporter ‚Üí –¥–∏–∑–µ–ª—å 0.85
- Ford Transit ‚Üí –¥–∏–∑–µ–ª—å 0.85

–ü–†–ò–ú–ï–†–´ –õ–ï–ì–ö–û–í–´–•:
- –õ–∞–¥–∞ –í–µ—Å—Ç–∞ ‚Üí –±–µ–Ω–∑–∏–Ω 0.95
- Toyota Camry ‚Üí –±–µ–Ω–∑–∏–Ω 0.9
- Volkswagen Passat ‚Üí –¥–∏–∑–µ–ª—å 0.7 (–≤ –†–§ —á–∞—â–µ –¥–∏–∑–µ–ª—å)

–û—Ç–≤–µ—á–∞–π JSON:
{
  "fuelType": "gasoline"|"diesel"|"unknown",
  "confidence": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 1,
  "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
  "year": –ø—Ä–∏–º–µ—Ä–Ω—ã–π –≥–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ),
  "engineType": "—Ç–∏–ø –¥–≤–∏–≥–∞—Ç–µ–ª—è" (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
}

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω –Ω–∞ 70%+ ‚Üí —É–∫–∞–∑—ã–≤–∞–π fuelType
- –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω –º–µ–Ω—å—à–µ 70% ‚Üí –≤–µ—Ä–Ω–∏ "unknown" —Å –Ω–∏–∑–∫–∏–º confidence
- –î–ª—è "–ú–µ—Ä—Å–µ–¥–µ—Å" –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏–π ‚Üí –¥–∏–∑–µ–ª—å (0.9), —Ç.–∫. –≤ –†–§ –ú–µ—Ä—Å–µ–¥–µ—Å—ã –≥—Ä—É–∑–æ–≤—ã–µ —á–∞—â–µ –¥–∏–∑–µ–ª—å–Ω—ã–µ`
          },
          {
            role: 'user',
            content: `–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:
–ú–æ–¥–µ–ª—å: ${vehicleModel}
${licensePlate ? `–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: ${licensePlate}` : ''}`
          }
        ],
        max_tokens: 500,
        temperature: 0.2
      });

      const content = response.choices[0]?.message?.content || '{}';

      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0]);

        console.log(`‚úÖ ${modelName}: —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω - ${result.fuelType} (${result.confidence})`);
        return {
          fuelType: result.fuelType || 'unknown',
          confidence: result.confidence || 0.5,
          reasoning: result.reasoning || '–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ –º–æ–¥–µ–ª–∏',
          year: result.year,
          engineType: result.engineType
        };
      }

      return {
        fuelType: 'unknown',
        confidence: 0.3,
        reasoning: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞'
      };
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ç–æ–ø–ª–∏–≤–∞:`, error);
      return {
        fuelType: 'unknown',
        confidence: 0,
        reasoning: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ç–∏–ø–∞ —Ç–æ–ø–ª–∏–≤–∞'
      };
    }
  }

  /**
   * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏ –†–§ –ø–æ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º —Ç—Ä–∞—Å—Å–∞–º
   * –ó–∞–¥–∞—á–∞ 10.4 –∏–∑ OCR-REPORTS.md
   */
  async calculateRouteDistance(
    fromCity: string,
    toCity: string
  ): Promise<{
    distance: number;
    distanceSource: 'ai' | 'cache' | 'user' | 'starline';
    confidence: number;
    reasoning?: string;
  }> {
    const modelName = this.getModelName();
    console.log(`üó∫Ô∏è ${modelName}: —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è ${fromCity} ‚Üí ${toCity}...`);

    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º StarLine Maps API (–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ –¥–ª—è –†–§)
    try {
      const { starLineMapsService } = await import('./starline-maps-service');
      const starlineResult = await starLineMapsService.calculateRoute(fromCity, toCity, 'auto');

      if (starlineResult && starlineResult.distance > 0) {
        console.log(`‚úÖ StarLine Maps: ${starlineResult.distance.toFixed(1)} –∫–º (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)`);
        return {
          distance: Math.round(starlineResult.distance),
          distanceSource: 'starline',
          confidence: starlineResult.confidence,
          reasoning: `–¢–æ—á–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–∞–º –†–§ (StarLine Maps)`
        };
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è StarLine Maps –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º GLM:', error);
    }

    // Fallback –Ω–∞ GLM (–º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    try {
      const response = await this.client.chat.completions.create({
        model: this.defaultModel,
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –†–æ—Å—Å–∏–∏ –∏ –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–∞–º.
–û–ø—Ä–µ–¥–µ–ª—è–π —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º —Ç—Ä–∞—Å—Å–∞–º –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏ –†–§.

–í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON! –ù–∏–∫–∞–∫–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–µ (–Ω–µ –ø–æ –ø—Ä—è–º–æ–π!)
- –û—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û —á–∏—Å–ª–æ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö
- –ï—Å–ª–∏ –≥–æ—Ä–æ–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Üí –≤–µ—Ä–Ω–∏ null

–ü–†–ò–ú–ï–†–´:
- –ú–æ—Å–∫–≤–∞ ‚Üí –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥: 703
- –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ ‚Üí –ú–æ—Å–∫–≤–∞: 1781
- –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ ‚Üí –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫: 3323
- –ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞: 797
- –ß–µ–ª—è–±–∏–Ω—Å–∫ ‚Üí –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥: 213

–î–æ–ø—É—Å—Ç–∏–º–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å: ¬±50 –∫–º (1-3%)

–û—Ç–≤–µ—á–∞–π JSON:
{
  "distance": —á–∏—Å–ª–æ –≤ –∫–º –∏–ª–∏ null,
  "confidence": –æ—Ç 0 –¥–æ 1,
  "reasoning": "–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ"
}`
          },
          {
            role: 'user',
            content: `–û–ø—Ä–µ–¥–µ–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–µ –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏:
–û—Ç–∫—É–¥–∞: ${fromCity}
–ö—É–¥–∞: ${toCity}`
          }
        ],
        max_tokens: 300,
        temperature: 0.1
      });

      const content = response.choices[0]?.message?.content || '{}';

      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0]);

        if (result.distance && result.distance > 0) {
          console.log(`‚úÖ ${modelName}: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ - ${result.distance} –∫–º`);
          return {
            distance: result.distance,
            distanceSource: 'ai',
            confidence: result.confidence || 0.8,
            reasoning: result.reasoning
          };
        }
      }

      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ
      console.warn(`‚ö†Ô∏è ${modelName}: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ`);
      return {
        distance: 0,
        distanceSource: 'ai',
        confidence: 0,
        reasoning: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏'
      };
    } catch (error) {
      console.error(`‚ùå ${modelName}: –æ—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è:`, error);
      return {
        distance: 0,
        distanceSource: 'ai',
        confidence: 0,
        reasoning: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è'
      };
    }
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ –∫–ª–∏–µ–Ω—Ç–∞
   */
  getStatus(): {
    apiKey: string;
    baseUrl: string;
    defaultModel: string;
  } {
    return {
      apiKey: this.client.apiKey ? '—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
      baseUrl: this.client.baseURL || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
      defaultModel: this.defaultModel
    };
  }
}